<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conversations - Nanny Admin</title>
  
  <!-- Preload critical resources -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  
  <!-- CSS -->
  <link rel="stylesheet" href="css/admin.css">
  <link rel="stylesheet" href="css/conversations.css">
  <link rel="stylesheet" href="css/global-search.css">
  <link rel="stylesheet" href="css/modal-override.css">
  
  <!-- Meta tags -->
  <meta name="description" content="Conversation history and transcripts for compassionate AI companion">
  <meta name="theme-color" content="#6366f1">
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%236366f1'/><g transform='translate(50,50) scale(1.5)'><path d='M12 2C8.5 2 6 4.5 6 7.5C6 8.2 6.1 8.9 6.3 9.5C5.8 9.3 5.3 9.2 4.8 9.2C3.8 9.2 3 10 3 11C3 12 3.8 12.8 4.8 12.8C5.3 12.8 5.8 12.7 6.3 12.5C6.5 12.8 6.8 13.1 7.1 13.3C7.5 13.6 8 13.8 8.5 13.9V14.5C8.5 15.3 9.2 16 10 16H14C14.8 16 15.5 15.3 15.5 14.5V13.9C16 13.8 16.5 13.6 16.9 13.3C17.2 13.1 17.5 12.8 17.7 12.5C18.2 12.7 18.7 12.8 19.2 12.8C20.2 12.8 21 12 21 11C21 10 20.2 9.2 19.2 9.2C18.7 9.2 18.2 9.3 17.7 9.5C17.9 8.9 18 8.2 18 7.5C18 4.5 15.5 2 12 2Z' fill='white'/><ellipse cx='12' cy='10' rx='4.5' ry='4' fill='%236366f1'/><path d='M9 14.5L10.5 15.5L12 15L13.5 15.5L15 14.5' stroke='white' stroke-width='0.5' fill='none'/><path d='M8 16C7.5 16 7 16.5 7 17V20C7 20.5 7.5 21 8 21H16C16.5 21 17 20.5 17 20V17C17 16.5 16.5 16 16 16' fill='white'/><path d='M10 17H14V20.5C14 20.8 13.8 21 13.5 21H10.5C10.2 21 10 20.8 10 20.5V17Z' fill='%236366f1'/><ellipse cx='6.5' cy='18' rx='1.5' ry='2.5' transform='rotate(-20 6.5 18)' fill='white'/><ellipse cx='17.5' cy='18' rx='1.5' ry='2.5' transform='rotate(20 17.5 18)' fill='white'/></g></svg>">
  
  <!-- Prevent FOUC -->
  <style>
    body { visibility: hidden; }
    .js body { visibility: visible; }
    
    /* Modal positioning handled by modal-override.css - removed redundant inline styles */
  </style>
  <script>document.documentElement.className = 'js';</script>
</head>
<body data-page="conversations">
  <!-- Admin Layout Container -->
  <div class="admin-layout">
    <!-- Main Content -->
    <main class="admin-main" role="main">
      <!-- Page Header -->
      <div class="page-header">
        <div class="header-content">
          <div class="header-left">
            <h1 class="page-title">Conversations</h1>
            <p class="page-description">Track mental health patterns through compassionate AI interactions</p>
          </div>
          <div class="header-actions">
            <button id="refresh-data" class="btn btn-outline" data-tooltip="Refresh conversation data">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
              Refresh
            </button>
          </div>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
          </div>
          <div class="stat-content">
            <div class="stat-value" id="conversations-today">--</div>
            <!-- Data: Count of conversations with start_time >= today -->
            <div class="stat-label">Conversations Today</div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
            </svg>
          </div>
          <div class="stat-content">
            <div class="stat-value" id="average-anxiety">--</div>
            <!-- Data: Average sentiment_scores from analytics table for last 7 days -->
            <div class="stat-label">Average Anxiety Level</div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <div class="stat-content">
            <div class="stat-value" id="engagement-time">--</div>
            <!-- Data: Sum of duration from conversations where start_time >= today -->
            <div class="stat-label">Engagement Time Today</div>
          </div>
        </div>
      </div>

      <!-- Filters Section -->
      <div class="filters-section glass-card" data-collapsible="true" data-collapsed="true" data-persist="conversation-filters">
        <div class="filters-header collapsible-header">
          <h3 class="filters-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
            Filters
          </h3>
          <div class="header-actions">
            <div class="search-input-container">
              <input type="text" id="global-search" class="form-input" placeholder="Search conversations...">
              <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
            </div>
            <button id="clear-all-filters" class="btn btn-sm btn-ghost">Clear All</button>
          </div>
        </div>
        
        <div class="filters-grid collapsible-content">
          <!-- Date Range Filter -->
          <div class="filter-group">
            <label class="filter-label">Date Range</label>
            <div class="filter-controls">
              <select id="date-range-filter" class="form-select">
                <option value="all">All Time</option>
                <option value="today">Today</option>
                <option value="week">Last 7 days</option>
                <option value="month">Last 30 days</option>
                <option value="custom">Custom Range</option>
              </select>
              <div id="custom-date-inputs" class="custom-date-inputs" style="display: none;">
                <input type="date" id="date-from" class="form-input" placeholder="From">
                <span class="date-separator">to</span>
                <input type="date" id="date-to" class="form-input" placeholder="To">
              </div>
            </div>
          </div>

          <!-- Duration Filter -->
          <div class="filter-group">
            <label class="filter-label">Duration</label>
            <select id="duration-filter" class="form-select">
              <option value="all">All Durations</option>
              <option value="short">Under 5 minutes</option>
              <option value="medium">5-15 minutes</option>
              <option value="long">Over 15 minutes</option>
            </select>
          </div>

          <!-- Emotional State Filter -->
          <div class="filter-group filter-group-emotional">
            <label class="filter-label">Emotional States</label>
            <div class="emotional-state-filters">
              <label class="checkbox-label">
                <input type="checkbox" value="calm" class="emotional-state-filter">
                <span class="checkmark calm"></span>
                <span class="state-badge calm">
                  <img src="/admin/assets/icons/emotional-states/calm.svg" alt="Calm" class="emotional-icon">
                  Calm
                </span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="mild_anxiety" class="emotional-state-filter">
                <span class="checkmark mild-anxiety"></span>
                <span class="state-badge mild-anxiety">
                  <img src="/admin/assets/icons/emotional-states/mild.svg" alt="Mild Anxiety" class="emotional-icon">
                  Mild Anxiety
                </span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="moderate_anxiety" class="emotional-state-filter">
                <span class="checkmark moderate-anxiety"></span>
                <span class="state-badge moderate-anxiety">
                  <img src="/admin/assets/icons/emotional-states/moderate.svg" alt="Moderate Anxiety" class="emotional-icon">
                  Moderate Anxiety
                </span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" value="high_anxiety" class="emotional-state-filter">
                <span class="checkmark high-anxiety"></span>
                <span class="state-badge high-anxiety">
                  <img src="/admin/assets/icons/emotional-states/high.svg" alt="High Anxiety" class="emotional-icon">
                  High Anxiety
                </span>
              </label>
            </div>
          </div>

        </div>
      </div>

      <!-- Data Table Section -->
      <div>
        <div id="table-container">
          <!-- DataTable will be inserted here -->
        </div>
        
        <!-- Loading State -->
        <div id="loading-state" class="loading-state" style="display: none;">
          <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading conversations...</p>
          </div>
        </div>
        
        <!-- Empty State -->
        <div id="empty-state" class="empty-state" style="display: none;">
          <div class="empty-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
          </div>
          <h3>No conversations found</h3>
          <p>Try adjusting your filters or check back later for new conversation data.</p>
          <button id="reset-filters-btn" class="btn btn-primary">Reset Filters</button>
        </div>

        <!-- Error State -->
        <div id="error-state" class="error-state" style="display: none;">
          <div class="error-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
          </div>
          <h3>Unable to load conversations</h3>
          <p>There was an error loading the conversation data. Please try refreshing the page.</p>
          <button id="retry-load-btn" class="btn btn-primary">Try Again</button>
        </div>
      </div>

    </main>

    <!-- Mobile Sidebar Overlay -->
    <div class="layout-overlay"></div>
  </div>

  <!-- Transcript Modal - MOVED TO BODY LEVEL FOR PROPER FULL-VIEWPORT COVERAGE -->
  <div id="transcript-modal" class="modal" style="display: none;">
    <div class="modal-overlay"></div>
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">Conversation Transcript</h3>
        <button class="modal-close" aria-label="Close modal">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div id="transcript-content">
          <!-- Transcript content will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="js/admin.js"></script>
  <script src="js/utils.js"></script>
  <script type="module" src="js/template-loader.js"></script>
  <script type="module" src="js/global-search.js"></script>
  <script type="module" src="js/conversations.js"></script>
  
  <!-- Set current year -->
  <script>
    document.getElementById('current-year').textContent = new Date().getFullYear();
  </script>
</body>
</html>