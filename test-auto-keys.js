#!/usr/bin/env node

/**
 * Test script to verify auto-generated memory keys functionality
 */

const DatabaseManager = require('./services/database-manager');
const MemoryService = require('./services/memory-service');
const { GptService } = require('./services/gpt-service');

async function testAutoGeneratedKeys() {
  console.log('üß™ Testing Auto-Generated Memory Keys');
  console.log('=====================================');
  
  try {
    // Initialize services
    const dbManager = DatabaseManager.getInstance();
    await dbManager.waitForInitialization();
    
    // Create GPT service for key generation
    const gptService = new GptService(null, null, null, dbManager);
    
    // Create memory service with GPT service
    const memoryService = new MemoryService(dbManager, gptService);
    
    // Set memory service reference in GPT service
    gptService.memoryService = memoryService;
    
    await memoryService.initialize();
    
    console.log('‚úÖ Services initialized successfully');
    
    // Test 1: Auto-generate key for family information
    console.log('\nüìù Test 1: Auto-generating key for family information');
    const result1 = await memoryService.saveMemory(null, 'My daughter Mary works as a doctor in Seattle and visits every Sunday', 'family');
    console.log(`   Generated key: "${result1.key}"`);
    console.log(`   Action: ${result1.action}`);
    
    // Test 2: Auto-generate key for preferences
    console.log('\nüìù Test 2: Auto-generating key for preferences');
    const result2 = await memoryService.saveMemory(null, 'I love classical music, especially Mozart and Beethoven. Jazz makes me anxious.', 'preferences');
    console.log(`   Generated key: "${result2.key}"`);
    console.log(`   Action: ${result2.action}`);
    
    // Test 3: Auto-generate key for health information
    console.log('\nüìù Test 3: Auto-generating key for health information');
    const result3 = await memoryService.saveMemory(null, 'Takes blood pressure medication twice daily at 8am and 8pm', 'health');
    console.log(`   Generated key: "${result3.key}"`);
    console.log(`   Action: ${result3.action}`);
    
    // Test 4: Verify fallback for manual key
    console.log('\nüìù Test 4: Using manual key (should still work)');
    const result4 = await memoryService.saveMemory('manual-test-key', 'This is a test with manual key', 'general');
    console.log(`   Key: "${result4.key}"`);
    console.log(`   Action: ${result4.action}`);
    
    // List all memories to verify
    console.log('\nüìã All stored memories:');
    const allKeys = await memoryService.getAllMemoryKeys();
    console.log(`   Facts: [${allKeys.facts.join(', ')}]`);
    console.log(`   Memories: [${allKeys.memories.join(', ')}]`);
    
    console.log('\n‚úÖ All tests completed successfully!');
    
  } catch (error) {
    console.error('‚ùå Test failed:', error);
    process.exit(1);
  }
}

testAutoGeneratedKeys();